<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>RobStore - Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B4SK4KQDHW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-B4SK4KQDHW');
    </script>

    <!-- GA4 Custom Event Helper -->
    <script>
        function ga_event(name, params = {}) {
            try { gtag('event', name, params); }
            catch(err) { console.warn("GA4 no disponible", err); }
        }
    </script>

    <style>
    :root{
        --primary: #007bff;
        --primary-dark: #0056b3;
        --secondary: #6c757d;
        --background: #f4f6f9;
        --surface: #ffffff;
        --text-primary: #212529;
        --text-muted: #6a7580;
        --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
        --border-radius: 8px;
        --max-w: 1200px;
    }
    *{box-sizing:border-box}
    body { 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        padding: 30px 24px;
        background: var(--background); 
        color: var(--text-primary); 
        line-height: 1.6;
    }
    .wrap { max-width: var(--max-w); margin: 0 auto; }

    header { 
        display:flex; justify-content:space-between; align-items:center; 
        gap:20px; 
        margin-bottom: 30px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid #e0e0e0; 
    }
    header h1 { margin:0; font-size:1.6rem; font-weight:700; }
    nav { display:flex; gap:12px; align-items:center; }

    a.btn, button {
        background: var(--primary);
        color: var(--surface);
        border: none; padding: 10px 18px;
        border-radius: var(--border-radius);
        cursor:pointer; text-decoration:none; display:inline-block;
        font-weight: 600; font-size: 0.9rem;
    }
    a.btn.secondary { background: var(--secondary); }

    #product-list {
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
    }
    .card {
        background: var(--surface);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
    }
    .price { font-weight:700; margin-top:10px; font-size: 1.25rem; color: var(--primary); }

    #cart-panel {
        position: fixed; right: 24px; top: 100px; width: 400px;
        background: var(--surface); 
        border-radius: var(--border-radius); 
        padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display:none; z-index:40;
    }

    #message { 
        margin-bottom: 20px; padding: 10px;
        background: #e6f7ff; border: 1px solid #91d5ff;
    }

    @media (max-width: 768px){
        #cart-panel{ left: 15px; right: 15px; top: auto; bottom: 15px; width: auto; }
    }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <div>
                <h1>RobStore — Tienda</h1>
                <div style="font-size:0.9rem;color:var(--text-muted)">Frontend simple integrado con tu API</div>
            </div>
            <nav>
                <div id="auth-area"></div>
                <a class="btn secondary" href="/admin/" target="_blank">Admin</a>
                <a class="btn" id="btn-refresh">Refrescar Productos</a>
            </nav>
        </header>

        <div id="message"></div>

        <div class="panel" id="auth-panel">
            <h3 style="margin-top:0">Acceso y Registro</h3>

            <!-- Registro -->
            <form id="form-register">
                <input name="username" placeholder="Usuario" required />
                <input name="email" type="email" placeholder="Email" required />
                <input name="password" type="password" placeholder="Contraseña" required />
                <input name="password2" type="password" placeholder="Repetir contraseña" required />
                <button type="submit">Registrar</button>
            </form>

            <hr />

            <!-- Login -->
            <form id="form-login">
                <input name="username" placeholder="Usuario" required />
                <input name="password" type="password" placeholder="Contraseña" required />
                <button type="submit">Iniciar sesión</button>
                <a class="btn secondary" id="btn-guest">Probar sin login</a>
            </form>
        </div>

        <div class="top-controls">
            <div style="font-weight:600">Catálogo de Productos</div>
            <a class="btn" id="btn-view-cart">Ver Carrito</a>
        </div>

        <div id="product-list"></div>

        <footer style="margin-top:40px;text-align:center;color:var(--text-muted);font-size:0.85rem">
            <p>Proyecto de Evaluación de eCommerce. Backend en Django / REST.</p>
        </footer>
    </div>

    <!-- PANEL CARRITO -->
    <div id="cart-panel">
        <h4>Mi Carrito</h4>
        <div id="cart-items" style="min-height: 50px;"></div>
        <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
            <button id="btn-clear-cart" class="secondary" style="background:#dc3545">Vaciar</button>
            <button id="btn-checkout">Finalizar compra</button>
            <button id="btn-close-cart" class="secondary">Cerrar</button>
        </div>
    </div>

<script>
/* ============================================================
   FUNCIONES BASE
============================================================ */
const API_BASE = location.origin + "/api";

function showMessage(text, timeout=4000){
    const el = document.getElementById("message");
    el.textContent = text || "";
    if(timeout>0) setTimeout(()=> el.textContent="", timeout);
}

function saveToken(access){ localStorage.setItem("access_token", access); }
function getToken(){ return localStorage.getItem("access_token"); }
function clearToken(){ localStorage.removeItem("access_token"); }

function escapeHtml(s){
    if(!s) return "";
    return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
}

/* ============================================================
   RENDER AUTH AREA
============================================================ */
function renderAuthArea(){
    const area = document.getElementById("auth-area");
    if(getToken()){
        area.innerHTML = `
            <span style="color:var(--text-muted)">Usuario autenticado</span>
            <button id="btn-logout" class="btn secondary">Cerrar sesión</button>
        `;
        document.getElementById("btn-logout").onclick = ()=>{
            clearToken();
            renderAuthArea();
            showMessage("Sesión cerrada");
        };
        document.getElementById("auth-panel").style.display = "none";
    }else{
        area.innerHTML = "";
        document.getElementById("auth-panel").style.display = "block";
    }
}

/* ============================================================
   PRODUCTOS
============================================================ */
async function loadProducts(){
    try{
        const res = await fetch(`${API_BASE}/products/`);
        const data = await res.json();

        const container = document.getElementById("product-list");
        container.innerHTML = "";

        if(!Array.isArray(data) || data.length===0){
            container.innerHTML = '<div class="card">No hay productos</div>';
            return;
        }

        data.forEach(p=>{
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
                <h3>${escapeHtml(p.name)}</h3>
                <div class="meta">${escapeHtml(p.description||"")}</div>
                <div class="price">$ ${p.price}</div>
                <div style="margin-top:15px;display:flex;gap:10px;">
                    <button class="btn add-btn" data-id="${p.id}" style="flex-grow:1;">Agregar al carrito</button>
                    <a class="btn secondary" href="#">Detalle</a>
                </div>
            `;
            container.appendChild(div);
        });

        document.querySelectorAll(".add-btn").forEach(b=>{
            b.addEventListener("click", async (e)=>{
                const id = e.currentTarget.getAttribute("data-id");
                await addToCart(id, 1);
            });
        });

    }catch(err){
        console.error(err);
        showMessage("Error cargando productos");
    }
}

/* ============================================================
   CARRITO - ADD
============================================================ */
async function addToCart(product_id, quantity=1){
    const token = getToken();
    if(!token){
        showMessage("Debes iniciar sesión");
        return;
    }
    try{
        const res = await fetch(`${API_BASE}/cart/add/`, {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "Authorization":"Bearer " + token
            },
            body: JSON.stringify({product_id:Number(product_id), quantity:Number(quantity)})
        });

        const data = await res.json();

        if(!res.ok){
            showMessage(data.detail || "Error");
            return;
        }

        showMessage("Añadido al carrito");

        /* GA4 EVENT: add_to_cart */
        ga_event("add_to_cart", {
            product_id: Number(product_id),
            quantity: Number(quantity)
        });

    }catch(err){
        console.error(err);
        showMessage("Error al agregar");
    }
}

/* ============================================================
   CARRITO - FETCH Y RENDER
============================================================ */
async function fetchCart(){
    const token = getToken();
    if(!token) return null;

    try{
        const res = await fetch(`${API_BASE}/cart/`, {
            headers:{ "Authorization":"Bearer "+token }
        });
        if(!res.ok) return null;
        return res.json();
    }catch(err){
        return null;
    }
}

async function renderCartPanel(){
    const cart = await fetchCart();
    const panel = document.getElementById("cart-panel");
    const itemsDiv = document.getElementById("cart-items");

    if(!cart || !cart.items || cart.items.length===0){
        itemsDiv.innerHTML = "<div>No hay items</div>";
    }else{
        itemsDiv.innerHTML = "";
        cart.items.forEach(it=>{
            const node = document.createElement("div");
            node.className = "cart-item";
            node.innerHTML = `
                <div>
                    <div>${escapeHtml(it.product.name)}</div>
                    <div class="meta">Cant: ${it.quantity}</div>
                </div>
                <div>$ ${it.product.price}</div>
            `;
            itemsDiv.appendChild(node);
        });
    }

    panel.style.display = "block";
}

/* ============================================================
   CARRITO - CHECKOUT
============================================================ */
async function checkout(){
    const token = getToken();
    if(!token){ showMessage("Inicia sesión"); return; }

    const res = await fetch(`${API_BASE}/cart/checkout/`, {
        method:"POST",
        headers:{ "Authorization":"Bearer "+token }
    });

    if(res.ok){
        const data = await res.json();
        showMessage("Compra realizada");

        /* GA4 EVENT: purchase */
        ga_event("purchase", {
            value: data.total ?? 0,
            currency: "USD"
        });

        await renderCartPanel();
    }else{
        showMessage("Error en checkout");
    }
}

/* ============================================================
   CARRITO - CLEAR
============================================================ */
async function clearCart(){
    const token = getToken();
    if(!token){ showMessage("Inicia sesión"); return; }

    const res = await fetch(`${API_BASE}/cart/clear/`, {
        method:"POST",
        headers:{ "Authorization":"Bearer "+token }
    });

    if(res.ok){
        showMessage("Carrito vaciado");
        await renderCartPanel();
    }
}

/* ============================================================
   AUTH: REGISTRO
============================================================ */
document.getElementById("form-register").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const form = ev.currentTarget;

    const payload = {
        username: form.username.value.trim(),
        email: form.email.value.trim(),
        password: form.password.value,
        password2: form.password2.value
    };

    try{
        const res = await fetch(`${API_BASE}/auth/register/`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload)
        });

        const data = await res.json();

        if(res.ok){
            showMessage("Usuario Registrado");

            /* GA4 EVENT: sign_up */
            ga_event("sign_up", {
                method: "form",
                username: payload.username
            });

            form.reset();
        }else{
            showMessage(JSON.stringify(data));
        }
    }catch(e){
        showMessage("Error en registro");
    }
});

/* ============================================================
   AUTH: LOGIN
============================================================ */
document.getElementById("form-login").addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const form = ev.currentTarget;

    const payload = {
        username: form.username.value.trim(),
        password: form.password.value
    };

    try{
        const res = await fetch(`${API_BASE}/auth/login/`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if(res.ok && data.access){
            saveToken(data.access);
            showMessage("Sesión iniciada");
            renderAuthArea();

            /* GA4 EVENT: login */
            ga_event("login", {
                method: "form",
                username: payload.username
            });

            form.reset();
        }else{
            showMessage(data.detail || "Error en login");
        }
    }catch(e){
        showMessage("Error login");
    }
});

/* ============================================================
   EVENTOS UI
============================================================ */
document.getElementById("btn-view-cart").addEventListener("click", renderCartPanel);
document.getElementById("btn-close-cart").addEventListener("click", ()=>{ document.getElementById("cart-panel").style.display='none'; });
document.getElementById("btn-checkout").addEventListener("click", checkout);
document.getElementById("btn-clear-cart").addEventListener("click", clearCart);
document.getElementById("btn-refresh").addEventListener("click", loadProducts);

/* ============================================================
   INIT
============================================================ */
renderAuthArea();
loadProducts();

</script>

</body>
</html>
