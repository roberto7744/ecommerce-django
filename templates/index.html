<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>RobStore - Tienda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
    /* #####################################################################
    #                           ESTILOS CSS PROFESIONAL                   #
    ##################################################################### 
    */
    /* ----- Variables y Reseteo ----- */
    :root{
        --primary: #007bff;          /* Azul primario */
        --primary-dark: #0056b3;
        --secondary: #6c757d;        /* Gris secundario */
        --background: #f4f6f9;      /* Fondo de la aplicación */
        --surface: #ffffff;          /* Fondo de tarjetas y paneles */
        --text-primary: #212529;     /* Texto principal oscuro */
        --text-muted: #6a7580;       /* Texto auxiliar */
        --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombra suave */
        --border-radius: 8px;
        --max-w: 1200px;
    }
    *{box-sizing:border-box}
    body { 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        padding: 30px 24px; /* Mayor padding para un look más abierto */
        background: var(--background); 
        color: var(--text-primary); 
        line-height: 1.6;
    }
    .wrap { 
        max-width: var(--max-w); 
        margin: 0 auto; 
    }

    /* ----- Encabezado y Navegación ----- */
    header { 
        display:flex; justify-content:space-between; align-items:center; 
        gap:20px; 
        margin-bottom: 30px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid #e0e0e0; 
    }
    header h1 { margin:0; font-size:1.6rem; font-weight:700; }
    nav { display:flex; gap:12px; align-items:center; }

    /* ----- Botones ----- */
    a.btn, button {
        background: var(--primary); color: var(--surface); 
        border: none; padding: 10px 18px; 
        border-radius: var(--border-radius);
        cursor:pointer; text-decoration:none; display:inline-block;
        font-weight: 600; font-size: 0.9rem;
        transition: background-color 0.2s ease;
    }
    a.btn:hover, button:hover {
        background: var(--primary-dark);
    }
    a.btn.secondary { background: var(--secondary); }
    a.btn.secondary:hover { background: #5a6268; }

    /* ----- Cuadrícula de Productos ----- */
    #product-list {
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
    }
    .card {
        background: var(--surface);
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-light);
        transition: transform 0.2s ease;
    }
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }
    .card h3 { margin:0 0 8px 0; font-size:1.2rem; font-weight:600; }
    .price { font-weight:700; margin-top:10px; font-size: 1.25rem; color: var(--primary); }
    .meta { color: var(--text-muted); font-size:0.9rem; margin-top:4px; }

    /* ----- Controles y Paneles ----- */
    .top-controls { 
        display:flex; justify-content:space-between; align-items:center; 
        flex-wrap:wrap; 
        margin-bottom:20px; 
        padding-top: 10px;
        font-size: 1.1rem;
    }
    .spacer { flex:1; }

    /* ----- Formularios y Paneles de Auth ----- */
    .panel { 
        background: var(--surface); 
        padding:20px; 
        border-radius:var(--border-radius); 
        margin-bottom:25px; 
        box-shadow: var(--shadow-light);
    }
    form { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="password"], input[type="email"] {
        padding:10px; border-radius:var(--border-radius); 
        border:1px solid #ced4da; 
        min-width:180px;
        flex-grow: 1;
    }
    hr { border: 0; border-top: 1px solid #f0f0f0; margin: 15px 0; }

    /* ----- Modal/Panel Carrito ----- */
    #cart-panel {
        position: fixed; right: 24px; top: 100px; width: 400px; max-width: calc(100% - 48px);
        background: var(--surface); 
        border-radius: var(--border-radius); 
        padding: 20px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display:none; z-index:40;
    }
    #cart-panel h4 { margin:0 0 15px 0; font-weight: 700; font-size: 1.3rem;}
    .cart-item { display:flex; justify-content:space-between; gap:15px; padding:12px 0; border-bottom: 1px solid #f0f0f0; }
    .cart-item:last-child { border-bottom: none; }

    /* ----- Mensajes ----- */
    #message { 
        margin-bottom: 20px; 
        padding: 10px; 
        background: #e6f7ff; 
        color: var(--primary-dark); 
        border: 1px solid #91d5ff; 
        border-radius: var(--border-radius);
    }

    /* ----- Responsive Media Queries ----- */
    @media (max-width: 768px){
        body { padding: 15px; }
        .wrap { padding: 0; }
        header { flex-direction: column; align-items:flex-start; gap:15px; }
        nav { flex-wrap: wrap; }
        
        #product-list {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Panel Carrito en Móviles */
        #cart-panel{ 
            left: 15px; 
            right: 15px; 
            top: auto; 
            bottom: 15px; 
            width: auto; 
            max-width: none; 
        }
    }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
            <div>
                <h1>RobStore — Tienda</h1>
                <div style="font-size:0.9rem;color:var(--text-muted)">Frontend simple integrado con tu API</div>
            </div>

            <nav>
                <div id="auth-area">
                    </div>
                <a class="btn secondary" href="/admin/" target="_blank">Admin</a>
                <a class="btn" id="btn-refresh">Refrescar Productos</a>
            </nav>
        </header>

        <div id="message"></div>

        <div class="panel" id="auth-panel">
            <h3 style="margin-top:0; font-size:1.1rem">Acceso y Registro</h3>
            <form id="form-register">
                <input name="username" placeholder="Usuario" required />
                <input name="email" type="email" placeholder="Email" required />
                <input name="password" type="password" placeholder="Contraseña" required />
                <input name="password2" type="password" placeholder="Repetir contraseña" required />
                <button type="submit">Registrar</button>
            </form>

            <hr />

            <form id="form-login">
                <input name="username" placeholder="Usuario" required />
                <input name="password" type="password" placeholder="Contraseña" required />
                <button type="submit">Iniciar sesión</button>
                <a class="btn secondary" id="btn-guest" style="margin-left:8px">Probar sin login</a>
            </form>
        </div>

        <div class="top-controls">
            <div style="font-weight:600">Catálogo de Productos</div>
            <div class="spacer"></div>
            <a class="btn" id="btn-view-cart">Ver Carrito</a>
        </div>

        <div id="product-list">
            </div>

        <footer style="margin-top:40px;text-align:center;color:var(--text-muted);font-size:0.85rem">
            <p>Proyecto de Evaluación de eCommerce. Backend en Django / REST.</p>
        </footer>
    </div>

    <div id="cart-panel" aria-hidden="true">
        <h4>Mi Carrito</h4>
        <div id="cart-items" style="min-height: 50px;"></div>
        <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
            <button id="btn-clear-cart" class="secondary" style="background:#dc3545">Vaciar</button>
            <button id="btn-checkout">Finalizar compra</button>
            <button id="btn-close-cart" class="secondary">Cerrar</button>
        </div>
    </div>

<script>
/*
    #####################################################################
    #                           LÓGICA JAVASCRIPT                       #
    #####################################################################
    El JavaScript permanece igual ya que gestiona la funcionalidad de la API.
*/

const API_BASE = location.origin + '/api'; 

// UTIL - mostrar mensajes
function showMessage(text, timeout=4000){
    const el = document.getElementById('message');
    el.textContent = text || '';
    if(timeout>0){
        setTimeout(()=> el.textContent = '', timeout);
    }
}

// TOKEN helpers
function saveToken(access){
    localStorage.setItem('access_token', access);
}
function getToken(){
    return localStorage.getItem('access_token');
}
function clearToken(){
    localStorage.removeItem('access_token');
}

// RENDER auth area (botones según estado)
function renderAuthArea(){
    const area = document.getElementById('auth-area');
    const token = getToken();
    if(token){
        area.innerHTML = `
            <span style="margin-right:12px;color:var(--text-muted); font-size:0.95rem;">Usuario Autenticado</span>
            <button id="btn-logout" class="btn secondary">Cerrar sesión</button>
        `;
        document.getElementById('btn-logout').onclick = ()=>{
            clearToken();
            renderAuthArea();
            showMessage('Sesión cerrada');
        };
        document.getElementById('auth-panel').style.display = 'none';
    }else{
        area.innerHTML = '';
        document.getElementById('auth-panel').style.display = 'block';
    }
}

/* ---------- PRODUCTOS ---------- */
async function loadProducts(){
    try{
        const res = await fetch(`${API_BASE}/products/`);
        const data = await res.json();
        const container = document.getElementById('product-list');
        container.innerHTML = '';
        if(!Array.isArray(data) || data.length === 0){
            container.innerHTML = '<div class="card">No hay productos. Crea productos desde /admin/</div>';
            return;
        }
        data.forEach(p=>{
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <h3>${escapeHtml(p.name)}</h3>
                <div class="meta">${escapeHtml(p.description || '')}</div>
                <div class="price">$ ${p.price}</div>
                <div style="margin-top:15px;display:flex;gap:10px;">
                    <button class="btn add-btn" data-id="${p.id}" style="flex-grow:1;">Agregar al carrito</button>
                    <a class="btn secondary" href="#" onclick="alert('Detalle simple:\\nID: ${p.id}\\nStock: ${p.stock}')" style="flex-grow:0;">Detalle</a>
                </div>
            `;
            container.appendChild(div);
        });

        // attach event listeners
        document.querySelectorAll('.add-btn').forEach(b=>{
            b.addEventListener('click', async (e)=>{
                const id = e.currentTarget.getAttribute('data-id');
                await addToCart(id, 1);
            });
        });

    }catch(err){
        console.error(err);
        showMessage('Error cargando productos');
    }
}

/* ---------- CART ---------- */
async function addToCart(product_id, quantity=1){
    const token = getToken();
    if(!token){
        showMessage('Debes iniciar sesión para agregar al carrito', 4000);
        return;
    }
    try{
        const res = await fetch(`${API_BASE}/cart/add/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ product_id: Number(product_id), quantity: Number(quantity) })
        });
        const data = await res.json();
        if(!res.ok){
            showMessage(data.detail || 'Error añadiendo al carrito', 4000);
            return;
        }
        showMessage(data.detail || 'Añadido al carrito', 3000);
    }catch(err){
        console.error(err);
        showMessage('Error de red al agregar al carrito');
    }
}

async function fetchCart(){
    const token = getToken();
    if(!token){
        showMessage('Inicia sesión para ver el carrito', 3000);
        return null;
    }
    try{
        const res = await fetch(`${API_BASE}/cart/`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if(!res.ok){
            showMessage('No se pudo obtener el carrito', 3000);
            return null;
        }
        const data = await res.json();
        return data;
    }catch(err){
        console.error(err);
        showMessage('Error al obtener carrito');
        return null;
    }
}

async function renderCartPanel(){
    const cart = await fetchCart();
    const panel = document.getElementById('cart-panel');
    const itemsDiv = document.getElementById('cart-items');
    if(!cart){
        itemsDiv.innerHTML = '<div>Carrito vacío o error</div>';
    }else{
        if(!cart.items || cart.items.length===0){
            itemsDiv.innerHTML = '<div>No hay items en el carrito.</div>';
        }else{
            itemsDiv.innerHTML = '';
            cart.items.forEach(it=>{
                const node = document.createElement('div');
                node.className = 'cart-item';
                node.innerHTML = `
                    <div>
                        <div style="font-weight:600">${escapeHtml(it.product.name)}</div>
                        <div class="meta">Cant: ${it.quantity}</div>
                    </div>
                    <div style="text-align:right">
                        <div class="meta" style="color:var(--text-primary);">$ ${it.product.price}</div>
                    </div>
                `;
                itemsDiv.appendChild(node);
            });
        }
    }
    panel.style.display = 'block';
    panel.setAttribute('aria-hidden', 'false');
}

/* ---------- CART actions ---------- */
async function checkout(){
    const token = getToken();
    if(!token){ showMessage('Inicia sesión para comprar'); return; }
    const res = await fetch(`${API_BASE}/cart/checkout/`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
    });
    if(res.ok){
        const data = await res.json();
        showMessage('Compra realizada correctamente', 4000);
        await renderCartPanel();
    }else{
        const err = await res.json().catch(()=>({detail:'Error'}));
        showMessage(err.detail || 'Error en checkout', 4000);
    }
}

async function clearCart(){
    const token = getToken();
    if(!token){ showMessage('Inicia sesión para vaciar'); return; }
    const res = await fetch(`${API_BASE}/cart/clear/`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
    });
    if(res.ok){
        showMessage('Carrito vaciado', 3000);
        await renderCartPanel();
    }else{
        showMessage('Error vaciando carrito');
    }
}

/* ---------- AUTH (register / login) ---------- */
document.getElementById('form-register').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const form = ev.currentTarget;
    const payload = {
        username: form.username.value.trim(),
        email: form.email.value.trim(),
        password: form.password.value,
        password2: form.password2.value
    };
    try{
        const res = await fetch(`${API_BASE}/auth/register/`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        if(res.ok){
            const data = await res.json();
            showMessage('Usuario creado: ' + data.username, 4000);
            form.reset();
        }else{
            const err = await res.json().catch(()=>({detail:'Error'}));
            showMessage(JSON.stringify(err));
        }
    }catch(e){ console.error(e); showMessage('Error registrando usuario'); }
});

document.getElementById('form-login').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const form = ev.currentTarget;
    const payload = {
        username: form.username.value.trim(),
        password: form.password.value
    };
    try{
        const res = await fetch(`${API_BASE}/auth/login/`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(res.ok && data.access){
            saveToken(data.access);
            showMessage('Inicio de sesión correcto');
            form.reset();
            renderAuthArea();
        }else{
            showMessage(data.detail || 'Error en login');
        }
    }catch(e){ console.error(e); showMessage('Error login'); }
});

/* ---------- UI events ---------- */
document.getElementById('btn-view-cart').addEventListener('click', ()=>{
    renderCartPanel();
});
document.getElementById('btn-close-cart').addEventListener('click', ()=>{
    document.getElementById('cart-panel').style.display='none';
});
document.getElementById('btn-checkout').addEventListener('click', async ()=>{
    await checkout();
});
document.getElementById('btn-clear-cart').addEventListener('click', async ()=>{
    await clearCart();
});
document.getElementById('btn-refresh').addEventListener('click', ()=>{
    loadProducts();
});
document.getElementById('btn-guest').addEventListener('click', ()=>{
    showMessage('Puedes crear cuenta o usar el admin para probar',4000);
});

/* ---------- helpers ---------- */
function escapeHtml(s){
    if(!s) return '';
    return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
}

/* ---------- init ---------- */
renderAuthArea();
loadProducts();
</script>

</body>
</html>